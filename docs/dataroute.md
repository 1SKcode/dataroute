# DataRoute Parser - Документация

## Введение

DataRoute Parser - это компонент для парсинга и интерпретации DSL (предметно-ориентированного языка),
предназначенного для описания маршрутов данных между источниками и целями. Парсер трансформирует
текстовое представление маршрутов в структурированное JSON-представление, которое может использоваться
для дальнейшей обработки данных.

## Принцип работы и архитектура

```
┌─────────────────┐      ┌───────────────┐      ┌───────────────┐      ┌───────────────┐
│  Исходный DSL   │ ───> │    Лексер     │ ───> │    Парсер     │ ───> │  Посетитель   │
│     (текст)     │      │ (токенизация) │      │ (создание AST)│      │(генераторJSON)│
└─────────────────┘      └───────────────┘      └───────────────┘      └───────────────┘
         │                      │                      │                      │
         │                      ▼                      ▼                      ▼
         │                ┌───────────────┐      ┌───────────────┐      ┌──────────────┐
         │                │ Список токенов│      │  Абстрактное  │      │  Конечный    │
         └───────────────>│  и их типов   │─────>│синтаксическое │─────>│  результат   │
                          │               │      │   дерево (AST)│      │    (JSON)    │
                          └───────────────┘      └───────────────┘      └──────────────┘
```

### Процесс обработки DSL

1. **Лексический анализ**:
   - Разбивает входной текст на токены
   - Идентифицирует типы токенов (источник, цель, маршрут и т.д.)
   - Извлекает значения из токенов

2. **Синтаксический анализ (Parser)**:
   - Создает абстрактное синтаксическое дерево (AST)
   - Организует токены в иерархическую структуру
   - Выполняет проверку структуры

3. **Генерация JSON (Visitor)**:
   - Обходит AST
   - Создает JSON-представление
   - Применяет бизнес-логику

## Компоненты системы

### 1. Перечисления (Enums)

```
┌───────────────┐     ┌───────────────┐     ┌───────────────────┐
│   TokenType   │     │   NodeType    │     │  PipelineItemType │
├───────────────┤     ├───────────────┤     ├───────────────────┤
│    SOURCE     │     │    PROGRAM    │     │      PY_FUNC      │
│    TARGET     │     │    SOURCE     │     │      DIRECT       │
│ ROUTE_HEADER  │     │    TARGET     │     │     CONDITION     │
│  ROUTE_LINE   │     │  ROUTE_BLOCK  │     │       EVENT       │
│   CONDITION   │     │  ROUTE_LINE   │     └───────────────────┘
│     EVENT     │     │   PIPELINE    │
└───────────────┘     │   FIELD_SRC   │
                      │   FIELD_DST   │
                      │   CONDITION   │
                      │     EVENT     │
                      │   FUNC_CALL   │
                      │  DIRECT_MAP   │
                      └───────────────┘
```

### 2. Базовые классы

```
┌───────────────┐
│    Token      │
└───────────────┘
        ▲
        │
        │
┌───────────────┐     ┌───────────────┐     ┌───────────────────┐
│    ASTNode    │<────│  ASTVisitor   │     │DataSourceStrategy │
├───────────────┤     ├───────────────┤     ├───────────────────┤
│  node_type    │     │visit_program()│     │   read_field()    │
│   accept()    │     │visit_source() │     └───────────────────┘
└───────────────┘     │visit_target() │              ▲
        ▲             │      ...      │              │
        │             └───────────────┘              │
        │                     ▲                      │
┌──────────────────────┐      │              ┌──────────────────┐
│   Конкретные узлы    │      │              │ Стратегии чтения │
│   (ProgramNode,      │      │              │ (DictStrategy,   │
│    SourceNode,       │      │              │  ListStrategy)   │
│    TargetNode...)    │      │              └──────────────────┘
└──────────────────────┘      │
                              │
                      ┌───────────────────┐
                      │ JSONGenerator     │
                      │ (конкретный       │
                      │  посетитель)      │
                      └───────────────────┘
```

### 3. Основные компоненты обработки

```
┌───────────────┐      ┌───────────────┐      ┌────────────────┐
│     Lexer     │───┬─>│    Parser     │───┬─>│ JSONGenerator  │
├───────────────┤   │  ├───────────────┤   │  ├────────────────┤
│  tokenize()   │   │  │    parse()    │   │  │ visit_*()      │
└───────────────┘   │  └───────────────┘   │  └────────────────┘
        ▲           │          ▲           │          ▲
        │           │          │           │          │
        │           │          │           │          │
        │           │          │           │          │
┌───────────────────────────────────────────────────────────────┐
│                      DataRouteParser                          │
├───────────────────────────────────────────────────────────────┤
│                         parse()                               │
└───────────────────────────────────────────────────────────────┘
```